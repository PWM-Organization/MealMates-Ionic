<ion-content class="generator-container">
  <div class="generator-header ion-padding">
    <h1>Editor de Recetas</h1>
  </div>

  <form [formGroup]="recipeForm" (ngSubmit)="addRecipe()" class="recipe-form" #form="ngForm">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Información Básica</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item class="form-group" lines="none">
          <ion-label position="stacked">Título de la Receta <span class="required">*</span></ion-label>
          <ion-input type="text" formControlName="title" placeholder="Ej: Pasta Mediterránea"></ion-input>
        </ion-item>
        <ion-text color="danger" *ngIf="recipeForm.get('title')?.errors?.['required'] && recipeForm.get('title')?.touched">
          <p class="error-message">El título es obligatorio</p>
        </ion-text>

        <ion-grid class="form-row">
          <ion-row>
            <ion-col size="12" size-md="6">
              <ion-item class="form-group" lines="none">
                <ion-label position="stacked">Tiempo (minutos) <span class="required">*</span></ion-label>
                <ion-input type="number" formControlName="prepTime"></ion-input>
              </ion-item>
              <ion-text color="danger" *ngIf="recipeForm.get('prepTime')?.errors?.['required'] && recipeForm.get('prepTime')?.touched">
                <p class="error-message">El tiempo de preparación es obligatorio</p>
              </ion-text>
            </ion-col>
            <ion-col size="12" size-md="6">
              <ion-item class="form-group" lines="none">
                <ion-label position="stacked">Dificultad <span class="required">*</span></ion-label>
                <ion-select formControlName="difficulty" placeholder="Selecciona una opción">
                  <ion-select-option value="easy">Fácil</ion-select-option>
                  <ion-select-option value="medium">Media</ion-select-option>
                  <ion-select-option value="hard">Difícil</ion-select-option>
                </ion-select>
              </ion-item>
              <ion-text color="danger" *ngIf="recipeForm.get('difficulty')?.errors?.['required'] && recipeForm.get('difficulty')?.touched">
                <p class="error-message">La dificultad es obligatoria</p>
              </ion-text>
            </ion-col>
          </ion-row>
        </ion-grid>

        <ion-item class="form-group" lines="none">
          <ion-label position="stacked">Categoría <span class="required">*</span></ion-label>
          <ion-select formControlName="category" placeholder="Selecciona una categoría">
            <ion-select-option value="appetizer">Entrante</ion-select-option>
            <ion-select-option value="main">Plato principal</ion-select-option>
            <ion-select-option value="dessert">Postre</ion-select-option>
            <ion-select-option value="drink">Bebida</ion-select-option>
            <ion-select-option value="snack">Aperitivo</ion-select-option>
          </ion-select>
        </ion-item>
        <ion-text color="danger" *ngIf="recipeForm.get('category')?.errors?.['required'] && recipeForm.get('category')?.touched">
          <p class="error-message">La categoría es obligatoria</p>
        </ion-text>

        <ion-item class="form-group" lines="none">
          <ion-label position="stacked">Descripción <span class="required">*</span></ion-label>
          <ion-textarea formControlName="description" placeholder="Breve descripción de la receta..." autoGrow="true"></ion-textarea>
        </ion-item>
        <ion-text color="danger" *ngIf="recipeForm.get('description')?.errors?.['required'] && recipeForm.get('description')?.touched">
          <p class="error-message">La descripción es obligatoria</p>
        </ion-text>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Ingredientes <span class="required">*</span></ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div formArrayName="ingredients" class="ingredients-list">
          <div *ngFor="let ingredientGroup of ingredients.controls; let i=index" [formGroupName]="i" class="ingredient-item">
            <ion-item lines="none">
              <ion-input type="text" formControlName="ingredient" placeholder="Ingrediente"></ion-input>
              <ion-input type="text" formControlName="quantity" placeholder="Cantidad"></ion-input>
              <ion-button fill="clear" color="danger" (click)="removeIngredient(i)" size="small">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ion-item>
            <ion-text color="danger" *ngIf="ingredients.at(i).get('ingredient')?.errors?.['required'] && ingredients.at(i).get('ingredient')?.touched">
              <p class="error-message">El ingrediente es obligatorio</p>
            </ion-text>
          </div>
        </div>
        <ion-button type="button" expand="block" fill="outline" color="primary" (click)="addIngredient()">
          <ion-icon name="add-outline" slot="start"></ion-icon>
          Añadir Ingrediente
        </ion-button>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Preparación <span class="required">*</span></ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div formArrayName="steps" class="steps-list">
          <div *ngFor="let step of steps.controls; let i=index" class="step-item">
            <ion-item lines="none">
              <ion-label slot="start" class="step-number">{{i + 1}}</ion-label>
              <ion-textarea [formControlName]="i" placeholder="Describe el paso..." autoGrow="true"></ion-textarea>
              <ion-button fill="clear" color="danger" (click)="removeStep(i)" size="small">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ion-item>
            <ion-text color="danger" *ngIf="steps.at(i)?.errors?.['required'] && steps.at(i)?.touched">
              <p class="error-message">El paso es obligatorio</p>
            </ion-text>
          </div>
        </div>
        <ion-button type="button" expand="block" fill="outline" color="primary" (click)="addStep()">
          <ion-icon name="add-outline" slot="start"></ion-icon>
          Añadir Paso
        </ion-button>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Imagen de la Receta <span class="required">*</span></ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="image-upload-area" (click)="fileInput.click()">
          <input #fileInput type="file" id="recipeImage" (change)="onImageSelected($event)" accept="image/jpeg, image/png, image/webp" hidden>
          <ion-icon name="image-outline" size="large"></ion-icon>
          <p>Seleccionar imagen (JPG, PNG o WebP)</p>
          <ion-text color="danger" *ngIf="!selectedImage && form.submitted">
            <p class="error-message">La imagen es obligatoria</p>
          </ion-text>
        </div>
        <div class="image-preview" *ngIf="imagePreview">
          <img [src]="imagePreview" alt="Vista previa" />
          <ion-button fill="clear" color="danger" class="remove-image" (click)="removeImage()" size="small">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <div class="form-actions">
      <ion-button type="button" fill="outline" color="medium" (click)="onCancel()">
        Cancelar
      </ion-button>
      <ion-button type="submit" color="success" [disabled]="!selectedImage || recipeForm.invalid">
        Guardar Receta
      </ion-button>
    </div>
  </form>
</ion-content>